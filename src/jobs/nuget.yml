description: >
  Build and push NuGet packages to a NuGet server.

executor:
  name: dotnet
  tag: <<parameters.builder_image_tag>>

parameters:
  base_version:
    description: Base version
    type: string
  builder_image_tag:
    default: '3.1'
    description: Tag of builder image
    type: string
  project_path:
    description: Project path for which to build NuGets
    type: string
  pipeline_id:
    type: integer
steps:
  - checkout
  - inject_version_data:
      base_version: <<parameters.base_version>>
      pipeline_id: <<parameters.pipeline_id>>
  - dotnet_nuget_pack:
      project_path: <<parameters.project_path>>
      output_directory: "/app/nupkgs"
  - dotnet_nuget_add_source:
      nuget_name: "Main"
      nuget_url: "$NUGET_URL"
      pre-steps:
        - run:
            name: Set nuget environment variables
            command: |
              echo 'export VAR_NUGET_USERNAME=$NUGET_USERNAME' >> $BASH_ENV
              echo 'export VAR_NUGET_PASSWORD=$NUGET_PASSWORD' >> $BASH_ENV
              echo 'export VAR_NUGET_URL=$NUGET_URL' >> $BASH_ENV
  - dotnet_nuget_push:
      nuget_name: "Main"
      source_folder: "/app/nupkgs/"
